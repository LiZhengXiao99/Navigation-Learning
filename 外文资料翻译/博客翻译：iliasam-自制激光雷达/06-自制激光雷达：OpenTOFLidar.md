> * 翻译自俄语文章：https://habr.com/ru/articles/485574/
> * 项目地址： https://github.com/iliasam/OpenTOFLidar

# 自制激光雷达：OpenTOFLidar

在这篇文章中，我想介绍一下我的脉冲（TOF）开源激光雷达项目--我是如何制作它的，以及取得了哪些成果。

[TOC]

## 一些理论

激光测距仪按工作原理可分为三大类：

* **三角测量法**：这种测距仪利用几何定律确定距离。测距仪测量激光束与照射到光电探测器上的反射光束之间的角度，并根据该角度值以及激光与光电探测器之间的距离，计算出当前与目标物的距离。这些测距仪各有优点：

  - 在所有测距仪中最为简单。

  - 可在近距离内高精度地测量距离。

  - 能以相当高的速度测量距离 - 高达 10 kHz。

    但也有缺点：

  - 随着距离的增加，测距精度会明显下降。

  - 激光必须长时间开启（光电探测器的灵敏度有限），因此为了安全起见，必须限制其功率。

  - 测距仪的尺寸越小，距离测量的精度就越低。

  这种测距仪用于机器人锄地机，以及在业余机器人技术中相当流行的 RPLIDAR 测距仪。它们的价格通常在 100-400 美元之间。

  我曾在文章中详细介绍过这种测距仪： [自制扫描激光测距仪](https://habr.com/ru/post/393685/)和[反向工程激光测距传感器](https://habr.com/ru/post/274879/)。

* **相位式**：在这些测距仪中，激光由高频信号调制。光束在 "飞 "向和飞离物体的传播过程中产生的延迟会导致用于驱动激光的信号与从物体接收到的信号之间产生相位偏移。
  这些测距仪具有以下优点：

  - 距离测量精度高（单位为毫米或更小）。可随着信噪比的降低而降低。
  - 可制作小型装置。

  但也有缺点：

  - 激光会持续运行，因此必须限制其功率。这导致在远距离上接收到的信号很低，从而影响测距仪的精度。
  - 这种测距仪的电子设备相对复杂。
  - 很难进行高速测量。

  这类测距仪主要用于工业和测量领域。激光卷尺大多只使用相位法测量距离。在机器人领域相当有名的激光雷达 "Hokuyo URG-04LX "也是基于相位法的。
  专用 3D 传感器（测距成像摄像机）也经常使用这种方法。

  我曾在文章中详细介绍过这种测距仪： 《[自制相位激光测距仪](https://habr.com/ru/post/213749/)》和《[激光卷尺的工作原理：逆向工程](https://habr.com/ru/post/327642/)》。

* **脉冲式**：也称为 "飞行时间"、Time-Of-Flight（TOF）。它们使用大多数人最熟悉的 "经典 "方法来测量距离--测距仪测量的是闪光 "飞 "到和飞离一个物体所需的时间。尽管这种方法看似简单，但由于光速极快，要制造出能够精确测量距离的测距仪却相当困难。

  这些测距仪也有优点：
  - 激光采用脉冲模式，可以产生超高功率脉冲（超过兆瓦）。因此可以测量非常远的距离（甚至到月球）。
  - 可以制造小型装置。VL53L0X 等传感器就采用了这种方法。
  - 测量速度非常快 - 100 kHz 或更快。
  但也有缺点：
  - 很难测量出高精度的距离（< ±0.5米）。
  - 这种测距仪的电子设备相对复杂。

  这类测距仪在军方、大地测量、遥感、工业、自动驾驶车辆、无人机上都得到了广泛应用，也就是说，在需要进行长距离测量的地方随处可见。

  我在逆向工程中遇到过类似的测距仪：[逆向工程 Leuze RS4 激光扫描仪](https://habr.com/ru/post/396357/)。不过，逆向工程设计现成的设备是一回事，但制作自己的测距仪却是另一回事。


## 脉冲激光测距仪的设计

激光测距仪的关键部件是电子元件和光学元件。如果测距仪是扫描测距仪（2D/3D），通常还需要机械部件。这就是我的测距仪的结构图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311154705648.png" alt="image-20240311154705648" style="zoom: 50%;" />

这种测距仪的主要电子元件：

* **脉冲激光器组件**：它包含激光器本身和控制激光器的电子设备。该节点的主要要求是能够产生最大功率的光脉冲，并具有尽可能陡峭的前沿。脉冲越强，接收信号的信噪比就越高，前沿越陡，距离测量的精度就越高。

* **光电探测器组件**：它包含一个光电探测器，用于接收物体反射的信号；用于供电的电子元件、信号放大器和比较器，用于从干扰中区分出有用的信号。这里的主要要求是能够在不增加过多干扰和不降低脉冲前沿陡度的情况下最大限度地接收信号。

* **时间测量节点**：这里有一个特殊的 "魔法"--高精度测量光脉冲的 "飞行 "时间。从 1 米的距离到物体，光脉冲经过的时间为 6.6 毫微秒，微乎其微！要获得 1 厘米的分辨率，就必须测量出 66 ps 精度的 "飞行 "时间。

  如果我们尝试使用传统的时间测量方法，即在 "飞行 "过程中对某个频率发生器发出的脉冲进行计数，那么要获得 1 厘米的分辨率，发生器的频率就必须大于 15 千兆赫！显然，要制造出能够在这样的频率下工作的发生器和计数器是非常困难的。

  因此，人们开发了特殊的 TDC（[时间数字转换器](https://en.wikipedia.org/wiki/Time-to-digital_converter)）芯片来测量如此小的时间间隔。这些芯片可以使用不同的时间测量方法，但最常见的是使用延迟线。Hubre 上有一篇很好的文章介绍了 TDC 的工作原理：时-数转换器（TDC）：[什么是 TDC 以及如何在 FPGA 中实现 TDC](https://habr.com/ru/post/352276/)。

* **微控制器（MCU）**：它负责在指定时间点产生激光脉冲，从 TDC 读取数据，计算与目标的距离，计算必要的修正，控制一些模拟电路参数，并将数据发送到计算机。

测距仪的光学元件可分为两部分：激光透镜和光电探测器透镜。测距仪中使用的激光二极管具有相当宽的光束模式（即不是窄光束，而是发散光束）。为了获得窄光束，需要使用不同类型的透镜。光电探测器透镜的作用是将物体的散射光聚焦到一个点上，也就是光电探测器的敏感区域。接下来，我将向您介绍我在测距仪中使用的镜头。

## 实践

如您所见，激光测距仪上有许多业余无线电爱好者完全不熟悉的部件和组件，因此我将尝试详细介绍它们的选择和工作原理。让我们逐一介绍。

### 脉冲激光器组件

最近，欧司朗 "[SPL PL90_3](https://www.osram.com/ecat/Radial%20T1%203-4%20SPL%20PL90_3/com/en/class_pim_web_catalog_103489/global/prd_pim_device_2220019/)"脉冲激光二极管的价格相对便宜，而且功率相当大。它们看起来是这样的：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311155025624.png" alt="image-20240311155025624" style="zoom: 33%;" />

它们的工作波长为 905 nm，脉冲功率高达 75 W。我想指出的是，绝对不可能在 CW 模式下使用这些二极管。为了获得这样的功率，必须通过二极管相当大的电流 - 30A！为了控制激光器，我们使用了以下电路（这是非常标准的电路）：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311155128075.png" alt="image-20240311155128075" style="zoom: 67%;" />

这里的激光二极管标为 D4。激光控制单元的工作原理非常简单。起初晶体管 Q2 关闭，激光不发光，电容器 C17 通过电阻 R18 充电，电压达到 Vlaser。事实上，这个电容器储存了用于发射激光的所有能量。它的能量并不是很大--在电压为 16V 和电容容量为 20 nF 的情况下，电容中储存的能量为 2.5 µJ。

在某一特定时刻，晶体管 DA6 的驱动器接收到一个脉冲，它将该脉冲放大，晶体管 Q2 急剧打开，激光器开始发光，从电容器中获取能量。激光闪光的持续时间恰恰受到电容器电容的限制。如果所有元件都非常理想，那么通过激光器的最大电流可能会非常大，但实际上它受到元件电感的严重限制。

这种电路的一个有用特性是，即使晶体管出现故障和短路，通过激光二极管的电流也会受到电阻 R18 的限制，不会超过 0.1 A。激光器在 0.5 A 电流时开始产生辐射，因此这种故障不会对视力造成危害。电阻器 R19 用于控制激光电流。它连接着一个微型高频 U.FL 连接器，通过它可以连接示波器来观察流经激光器的电流形状。以下是 Vlaser=15V 时的示波器示例：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311155222927.png" alt="image-20240311155222927" style="zoom: 33%;" />

可以看出，电流脉冲持续时间约为 25 毫微秒，脉冲期间的电流波动是由于共振现象造成的。在这种情况下，最大电压值与约 15A 的最大电流相对应。使用带有放大器的高速 APD 光电探测器，我获得了显示激光信号波形的振荡图（通道 2，信号为反相）：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311155401943.png" alt="image-20240311155401943" style="zoom:50%;" />

可以看出，激光前沿的持续时间约为 10ns。通过调节 Vlaser 电压，可以调整最大激光电流。在 DA1 芯片上有一个直流-直流转换器节点，其输出电压可由微控制器调节。为了通知 TDC 芯片激光器已经开启，DA5 芯片上有一个特殊的节点。该芯片是一个高速比较器，当通过激光器的电流达到一定值时就会触发。

### 光电探测器组件

目前，雪崩光电二极管（APD）最常用作激光测距仪的光电探测器。与传统光电二极管不同的是，雪崩光电二极管本身具有光电流放大功能，从而提高了灵敏度。从电路的角度来看，这是非常有用的，因为在距离较远的情况下，传统光电二极管的光电流很难放大 - 它会在噪声放大器的水平上丢失。长期以来，APD 的价格相当昂贵（> 100 美元），而且很难获得，但现在情况已经发生了变化。

例如，在 Digikey 上，MTAPD-07-013 光电二极管的售价为 24 美元。我在上一版测距仪中使用的就是这种二极管。在 Aliexpress 上，您可以找到更便宜的 AD500-8，售价为 10-15 美元。这个价格有点奇怪，因为它们在 Mouser 上的售价超过 100 美元。不过，我曾在第一版测距仪中使用过这种光电二极管，其性能相当不错。上述两种光电二极管都有一个直径为 0.5 毫米的感应垫。在 aliexpress 上，AD230-8 光电二极管的售价为 24 美元，但其感应垫直径为 0.2 毫米。这虽然降低了光电二极管的电容，但却使光学器件的对准变得复杂。


雪崩光电二极管的一个重要特点是其增益取决于反向偏置电压的大小和外壳温度。以下是 AD500-8 TO 光电二极管数据表中有关这种依赖性的示例：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311155504783.png" alt="image-20240311155504783" style="zoom: 50%;" />

可以看出，当电压高于 70V 时，增益开始显著增加。当电压接近 90V 时，光电二极管对电压的增益灵敏度明显增加。随着增益的增加，噪声电平也随之增加。如果继续增加电压，光电二极管就会发生雪崩击穿--通过光电二极管的电流大幅增加，噪声变得非常大，对光没有任何反应。与此同时，光电二极管不会失效（如果不增加电流）。

为了使光电二极管产生足够高的偏置电压，我在设计中使用了直流-直流转换器，其 PWM 信号由微控制器产生。该转换器包括 Q1、L5、D1 和 C10。R8/R9 上的电阻分压器用于测量电压。电压反馈由微控制器实现。PWM 频率为 100 kHz。我试图对 PWM 产生和激光启动进行同步控制，因为我认为微小的电压波动会降低测量精度，但我没有注意到同步和非同步模式之间有任何区别。显然，RC 滤波器 R10-C11 发挥了很好的作用。

现在，我们应该转向光电二极管信号的放大器。传统上，[跨阻放大器（TIA）](https://ru.wikipedia.org/wiki/%D0%9E%D0%BF%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%BE%D0%BD%D0%BD%D1%8B%D0%B9_%D1%83%D1%81%D0%B8%D0%BB%D0%B8%D1%82%D0%B5%D0%BB%D1%8C_%D1%81_%D1%82%D0%BE%D0%BA%D0%BE%D0%B2%D0%BE%D0%B9_%D0%BE%D0%B1%D1%80%D0%B0%D1%82%D0%BD%D0%BE%D0%B9_%D1%81%D0%B2%D1%8F%D0%B7%D1%8C%D1%8E)被用作此类放大器。这种放大器接收电流作为输入，并输出与之成正比的电压。在最简单的情况下，它是一个带有单反馈电阻的运算放大器：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311155559180.png" alt="image-20240311155559180" style="zoom: 33%;" />

例如，您可以在[这里](http://digitrode.ru/articles/2182-chto-takoe-transimpedansnyy-usilitel-i-kak-on-rabotaet.html)了解更多有关 TIA 的信息。

要制作脉冲测距仪，需要使用信号带宽大、输入电容小的 TIA。可用的芯片不多，例如MAX3658、MAX40658 和 OPA858。在我的激光雷达中，我使用了 MAX3658。该芯片专为光电二极管设计，增益为 18000，带宽为 580MHz。此外，该芯片还内置了一个滤波器（直流消除电路），可切断低频。该芯片的缺点是其输出级的结构比较特殊：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311155714325.png" alt="image-20240311155714325" style="zoom:50%;" />

这不是推挽式输出，而是集电极开路+输出端对电源的强上拉，如（[电流模式逻辑 - CML](https://en.wikipedia.org/wiki/Current-mode_logic)）。
为了增加其中一个输出端的电压，芯片需要关闭一个晶体管，即电压的增加总是通过上拉电阻实现的。这会导致信号的定时特性降低。


该芯片的另一个缺点是，它不包含针对输入端静态电压的保护功能。

> 请注意 MAX3658 芯片非常怕静电电压！安装时应尽可能小心。在我的激光雷达中，我在芯片的输入电路中安装了一个保护二极管 D6，最好在安装 TIA 之前将其安装到电路板上。

不幸的是，在我的实验中，有 4 个这样的芯片出现了故障，显然是由于静电造成的。我从未在其他微型芯片上遇到过这种情况。因此，我得到了以下光电探测器组件方案：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311155841509.png" alt="image-20240311155841509" style="zoom: 67%;" />

连接器 J1 用于观察 TIA 输出端的信号波形。电容器 C12、C13 连接到下一个节点--时间测量节点。

### 时间测量单位

通过使用现成的 TDC 芯片，该组件非常简单。廉价微电路的选择余地也很小。有 TDC7200，有 TDC-GP21/22，其他芯片通常价格昂贵，很难买到。我在激光雷达中使用的是 TDC-GP21。

这种芯片设计用于超声波液体流量计，但也可用于 TOF 测距仪。该芯片的定时离散化 (BIN) 约为 90 ps。TDC 由微控制器通过 SPI 控制。

TDC 有两个独立的时间测量通道（STOP1/2 线），我将电路中两个比较器（上述激光比较器和 TIA 信号比较器）的信号接入其中。此外，该 TDC 还可以在其线路上输出 "FIRE "信号来控制超声波发射器，因此用它来控制激光器也很方便。在这种情况下，根据微控制器的指令，TDC 向激光节点发送开启信号，并立即开始测量时间（TDC 的 "START "线在 TDC 内部与 "FIRE "线相连）。芯片 "开始 "和 "停止 "信号之间的最小时限为 3.5 毫微秒，但在实际电路中，从发送 "开始 "信号到激光器出现电流之间的延迟时间要比这个时间长得多。因此，短距离测量不成问题。

TDC-GP21 可以同时记录多个连续事件的时间。一方面，在脉冲激光器中，这种模式可用于测量几个连续物体的距离（例如，测量穿过玻璃或树枝的距离），但我没有采用这种模式。相反，我对 STOP2 通道进行了配置，以检测来自 TIA 比较器的信号的正边和负边。这样，通过记录接收脉冲两个边沿的时间，就可以测量脉冲持续时间。这是非常重要的信息，我将在下文中讨论。

接收到物体反射的信号后，就可以从 TDC 中读取数据。需要注意的是，该芯片有一个对接收到的信号进行初级处理的机制（ALU），这是无法绕过的，也就是说，您无法从芯片中获取 "原始 "数据。每次读取信息前，必须告诉 TDC 应执行哪种计算，然后等待，最后才读取信息。
将 STOP2 - STOP1 时间相减，就得到了所需的 "飞行时间"，但其中包括电路节点中出现的各种延迟。必须重新配置 TDC 才能获得脉冲宽度信息。

TIA 输出幅度很小（<200 mV）的模拟信号，而 TDC 则需要数字信号。为了将一个信号转换成另一个信号，使用了一个基于 DA4 芯片的比较器 ADCMP600。该芯片的参数如下：

* 传播延迟 3.5 毫微秒。
* 过驱动色散：1.2 毫微秒
* 共模色散：200 ps。

虽然不能说比较器的速度非常快，但对于精确到几厘米的距离测量来说，它还是合适的。速度更快的比较器通常没有 TTL/CMOS 输出，但有一些 LVPECL 输出，这对驱动选定的 TDC 会有问题。由于 TIA 输出的信号是差分信号，而您又希望能够调整比较器的阈值，因此必须制作下图所示的电路：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311180122455.png" alt="image-20240311180122455" style="zoom: 67%;" />

比较器阈值由微控制器通过 "COMP_DAC "线产生的电压决定。该电压决定了电阻 R15 上的压降。当 TIA 输出端没有信号时，比较器输入端就会收到该电压差。需要注意的是，将电阻器连接到比较器时，比较器输入端的电压差为负值，因此比较器的输出为 0。当 TIA 输出端出现信号时，该信号通过电容器 C12、C13，R15 上的电压极性反转，当电压越过 0 时，比较器切换到 1。

### 其余电子设备

微控制器（MCU）。我使用 STM32F303CBT6 微控制器来控制激光雷达。在所述激光雷达中，微控制器执行以下功能：

* 使用内置 DAC 控制激光电压。
* 测量 APD 电压。
* 通过产生具有所需填充因子的 PWM 来控制 APD 电压。
* 使用板载 DAC 设置比较器阈值电压。
* 控制 TDC 运行（初始化、测量启动、数据读出）。
* 接收镜像编码器的数据。
* 控制反射镜电机（下文将详细介绍编码器和电机）。
* 提供与计算机的通信 - 通过计算机的命令更改激光雷达设置，向计算机发送数据。
* 修正从 TDC 接收的数据，并重新计算距离。
* 从闪存中保存和读取设置。

下面我将详细介绍数据校正。将模拟信号转换为数字信号的过程在比较器中进行，在时间上总是有一些模糊性：在相同的比较器阈值下，根据信号幅度的不同，比较器的切换时间也会不同：

这个问题可以通过根据振幅对飞行时间测量结果进行软件修正来解决。实际上，要测量如此快速和微小信号的振幅是相当困难的。此外，TIA 芯片的饱和阈值相当低--当输入光电流电平过高时，其输出端的信号振幅就会停止变化。事实证明，通过 TDC 测量脉冲持续时间（我在上文中已经介绍过），并使用该参数进行信号校正要容易得多。我将进一步介绍校正的计算方法。

我为微控制器编写了两个版本的控制程序。其中一个比较简单，只能在非扫描模式下使用。在这个固件版本中，激光以 1000 Hz 的频率持续 "闪烁"，因此这种模式便于测试电子设备和校准。
第二种固件变体--主要变体--支持二维空间扫描。

电机控制组件。为了旋转扫描镜，我使用了无集电极电机（[BLDC](https://en.wikipedia.org/wiki/Brushless_DC_electric_motor)），这需要一种特殊的控制方法。我使用了 [DRV11873](http://www.ti.com/product/DRV11873) 作为控制芯片，这种芯片非常常见，不需要大量的附加元件。电机速度由施加到 MCU 芯片输入端的 PWM 信号控制。该节点的电路取自芯片的数据手册，并无特别之处。不过，所选的电机 + 驱动器组合有一个缺点，即在接通电源时，电机会不受控制地加速到很高的速度。据我所知，这是由于 DRV11873 的反向电磁场检测方法造成的。

因此，这是激光雷达的最终方案：

激光雷达印刷电路板的跟踪并不容易，因为电路板上的激光节点含有超过 15A 的电流，光电二极管节点含有微安培的光电流。我决定制作一个四层电路板，因为这是组织高质量接地多边形的唯一方法--在四层电路板的情况下，内层之一仅用于接地多边形。从原理图中可以看到，我将所有激光雷达接地分为三种类型--激光节点接地 (LGND)、电机节点接地 (MGND)、主接地多边形 (GND)。这些地线只连接了几个点。为了减少激光器电路中的电感，必须将激光器 D4、晶体管 Q2、R19 和 C17 放在尽可能靠近的位置 - 事实上，当激光器打开时，通过这些元件的电流是短路的。

激光雷达印刷电路板的跟踪并不容易，因为电路板上的激光节点含有超过 15A 的电流，光电二极管节点含有微安培的光电流。我决定制作一个四层电路板，因为这是组织高质量接地多边形的唯一方法--在四层电路板的情况下，内层之一仅用于接地多边形。从原理图中可以看到，我将所有激光雷达接地分为三种类型--激光节点接地 (LGND)、电机节点接地 (MGND)、主接地多边形 (GND)。这些地线只连接了几个点。

为了减少激光器电路中的电感，必须将激光器 D4、晶体管 Q2、R19、C17 尽可能靠近 - 事实上，当激光器打开时，通过这些元件的电流是短路的。同样重要的是，光电二极管要尽可能靠近 TIA 输入端。当然，在跟踪模拟和数字电路时，还必须遵循一大堆其他规则。不过，我不是专业的 PCB 设计师，所以不能保证电路板的布局符合所有规则。

这就是组装好的电路板的样子（从光学元件一侧看）：

<img src="C:/Users/李郑骁的spin5/AppData/Roaming/Typora/typora-user-images/image-20240311184418375.png" alt="image-20240311184418375" style="zoom: 50%;" />

而从另一侧（微控制器一侧）来看：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311184500980.png" alt="image-20240311184500980" style="zoom: 50%;" />

### 光学元件

我可以假定，许多不熟悉光电技术的人可能会因为缺乏这方面的知识而在现阶段遇到问题。实际上，对于像我这样的简单测距仪来说，一切都很简单。首先，值得介绍一下激光透镜。


如前所述，激光透镜的设计目的是接收来自激光二极管的窄光束。激光通常被视为点光源，因此为了获得窄光束，只需使用单个集光（正）透镜即可。


使用标准 M12 镜头作为镜头非常方便，它们被广泛用于闭路电视摄像机。生产和销售的标准透镜座可用于将透镜拧到 PCB 上。激光二极管的发射区域为矩形，"SPL PL90_3 "二极管的发射区域尺寸为 200 X 10 μm。因此，激光束也是矩形的。从图中可以看出，发光点很长，这导致透镜输出端的辐射仍有一定的发散性。正因为如此，随着距离的增加，落在物体上的光斑也会增大。事实上，激光辐射的发散角决定了激光雷达的角度分辨率（每转的测量次数）。

除了发射区域的大小，透镜的焦距也会影响发散角。焦距越大，辐射发散越小：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311184708527.png" alt="image-20240311184708527" style="zoom:50%;" />

如果使用 12 毫米焦距的镜头，辐射的发散角约为 1 度；如果使用 25 毫米焦距的镜头，辐射的发散角已经约为 0.45 度。我设法在 Aliexpress 上找到了一个比较合适的镜头：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311184747454.png" alt="image-20240311184747454" style="zoom:67%;" />

其参数为 25 毫米；M12*0.5；1/3；F2.0。这个镜头很短，因此为了将它连接到支架上，我使用了额外购买的部件：M12 扩展适配器。这是激光光斑在大约 1.8 米（左）的距离上的样子：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311184825770.png" alt="image-20240311184825770" style="zoom: 80%;" />

右侧是激光卷尺测得的光斑，直径约为 4 毫米。您可以看到，激光雷达的光斑约大 2.5 倍，因此宽度约为 10 毫米。重要的是，激光雷达透镜应尽可能靠近。如果增加镜片之间的距离，激光雷达在短距离内就会停止接收反射辐射，即辐射无法到达光电探测器。这一要求限制了透镜的尺寸。在我的设计中，激光透镜的直径不能超过 20 毫米。


我还试验了一种自制透镜，它是用相机上的单透镜和网络摄像头上的 M12 塑料镜筒制成的：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311184852751.png" alt="image-20240311184852751" style="zoom:67%;" />

所使用的透镜可以透射红外辐射，因此效果很好，但由于焦距较短（约 13 毫米），透镜后的辐射发散太大。

现在值得介绍一下光电探测器镜头。在激光测距仪中，最重要的参数是入口瞳孔的直径。这个参数越大，到达光电二极管的反射光就越多，信噪比就越高。这意味着镜头的直径应尽可能大。这就是我决定使用 CS 卡口标准镜头的原因。这种透镜也可以用螺丝固定在电路板上。在这个激光雷达中，我使用了一个购买的镜头，参数为 25mm；F1.2；CS 1/2.5"。您可以看到，该镜头的光圈很大，但焦距却相当长（25 毫米），因此入口瞳孔直径相当大。根据计算，入口瞳孔的直径应该是 20 毫米左右，但实际上显然接近 14 毫米。

我还尝试了一个自制的镜头，使用了一个直径为 25 毫米的镜头和一个不需要的 CS 镜头的部件。这个透镜的功率确实更好（光电二极管的信号明显更高），但它会捕捉到扫描镜的过度反射，因此并不适合我。

如果激光雷达需要在强光条件下（尤其是室外）使用，则应在光电二极管和透镜之间安装一个波长为 905 nm 的干涉滤光镜。滤光片通常是圆形的，可以粘在镜头的出光孔上。我没有使用滤光镜--在室内光线下，激光雷达可以在没有滤光镜的情况下工作。


我注意到，在激光和光电探测器的情况下，透镜的工作波长相同，因此不会出现色差问题。此外，在使用足够大面积（0.5 毫米）的 APD 时，对透镜参数没有严格要求。这意味着这种测距仪可以使用单透镜镜头。因此，激光测距仪的外观是这样的：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311185000946.png" alt="image-20240311185000946" style="zoom: 50%;" />

与许多其他光电设备一样，这种测距仪也需要对准--将激光透镜调到最佳位置。为了能够移动激光透镜，电路板上用于固定透镜的孔要大于螺钉的直径。对准本身包括找到透镜支架的位置，使光电二极管接收到的信号振幅最大。这就是示波器上的变化：

<img src="https://habrastorage.org/getpro/habr/post_images/8ad/bdd/b90/8adbddb90802dd1a50bee564a32ac706.gif" alt="GIF-signal" style="zoom: 67%;" />

可以很清楚地看到放大器过渡到饱和模式。光电流的振幅可以通过脉冲长度来判断。现在必须添加机械装置，使激光测距仪能够进行扫描。

### 机械

如果不讨论固态激光雷达，我们可以区分两种二维空间扫描方法--扫描可以通过旋转整个测距仪或旋转相对于激光雷达光轴倾斜 45 度的反射镜来完成。

第一种方法的优点：

* 不需要足够大的镜子，而这种镜子很难制造
* 镜面无损耗，镜面无反射问题
* 如果在水平面上扫描，激光雷达的高度可以做得很小
* 360 度全方位扫描没有问题

缺点：

* 必须以某种方式向旋转电子设备传输电力和数据。这意味着必须使用滑动触点或电感+光耦合。
* 沉重的旋转结构难以平衡
* 需要某种机械装置来旋转沉重的结构。
* 需要功率相对较大的电机
* 旋转电子设备难以调试。

这是 "锄头 "激光雷达和激光雷达激光雷达使用的扫描方法。


使用镜面扫描的优点：

* 镜子及其支架可以做得足够轻，这样在高速运转时就不会有很大的平衡问题
* 轻巧的反射镜可以直接安装在无电机马达的轴上。
* 只有镜子旋转，因此无需通过旋转元件传输电力

缺点：

* 反射镜需要以某种方式安装在激光雷达透镜上，安装位置会遮住部分 "视角"。即使使用整个测距仪的透明管外壳作为支架，仍需要将电线连接到反射镜电机和编码器，而这些电线会阻挡光束。
* 镜面会造成光损失和过度反射
* 测距仪高度高

由于我想制作一个高扫描速度（至少 15 转/秒）的激光雷达，因此决定使用扫描镜。对扫描镜的一个重要要求是，它必须具有外部反射涂层（即涂层必须位于扫描镜的前表面）。如果使用普通的矩形镜子进行扫描，其边缘将无法发挥任何作用--光线将无法到达那里。这种镜子的理想形状是椭圆，因为它的投影是一个圆。我已经在一个[现成的激光雷达](https://habr.com/ru/post/396357/)中遇到过这样的镜子。这种形状的镜子很难制作，因此激光雷达通常使用八角形镜子。

我曾尝试自己制作这样一面镜子，但由于缺乏切割小尺寸玻璃的经验，只弄坏了几块镜坯。不过我还是在 Aliexpress 上找到了一家公司，他们按照我的图纸制作了四面镜子，价格为 15 美元。不幸的是，订购的镜子有一个缺点--它几乎将信号衰减了 2 倍。据我所知，这是由于镜子表面镀了一层铝，可能还有某种保护层。这可能会导致波长为 905 纳米时的反射系数下降到 0.7，而考虑到光束通过镜子两次，反射系数仅为 0.5 左右。

镜子必须以某种方式旋转。不可能简单地将其连接到集电极电机的轴上，因为大多数此类电机的设计转速太高。我不想使用齿轮箱--太复杂，而且会产生不必要的噪音。

理想的解决方案是使用内置电子元件（如电脑风扇）的无集电极电机，但遗憾的是我找不到合适的电机。我曾想过使用一个电机和一个风扇，但小风扇的电机即使在低电压下也转得太快，而大风扇的电机又不符合尺寸要求。

因此，我决定使用购买的无集电极电机（BLDC）。我专门在 Aliexpress 上找到了一个小的扁平 Outrunner 电机，它有一个轴，我可以在上面安装一个编码器圆盘：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311185443126.png" alt="image-20240311185443126" style="zoom:50%;" />

为了将镜子固定在电机上，我们打印了一个特殊的部件--镜子支架。在镜架上为电机制作了一个特殊的凹槽，镜子本身则粘在镜架上。这就是它的外观：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311185505049.png" alt="image-20240311185505049" style="zoom:50%;" />

为了让微控制器能够确定镜子的指向，我在电机轴上安装了一个简单的光电编码器。我从一只旧鼠标上取下编码器的圆盘，它有 65 个槽，与电机轴配合得很好。我用胶带粘住了编码器的一个插槽--它被用作参考，即零角度指示：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311185525047.png" alt="image-20240311185525047" style="zoom:33%;" />

我使用了一台旧打印机上的光耦合器。光耦合器的信号连接到单片机内置的比较器。这是光电耦合器的光敏晶体管在越过原点时发出的信号：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311185552419.png" alt="image-20240311185552419" style="zoom: 67%;" />

由此产生的激光雷达看起来是这样的：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311185614942.png" alt="image-20240311185614942" style="zoom:33%;" />

在照片中，您可以看到一块白色塑料板垂直安装在镜面上。这块板（"参考板"）用于自动校准测距仪。固件以毫米为单位指定了到这块板的距离，因此通过测量到这块板的距离，可以计算出 TDC 返回结果中的零点偏移。

### 安全措施

在这款测距仪中，我使用了波长为 905 纳米的强力激光。这种辐射眼睛是完全看不见的，但它会损伤视网膜，因此对视力相当危险。

> 注意！在非扫描模式下使用微控制器固件尤其危险，因为在这种模式下，激光以 1 kHz 的频率持续工作，并持续指向一个点。我用专门的功率计测量了激光透镜输出端的平均光功率 - 0.35 mW（激光节点电源电压为 16V）。即使是这样的功率也是危险的，因为辐射是不可见的！在这种模式下使用测距仪时，必须佩戴安全眼镜！

在扫描模式下，由于脉冲频率增加，平均辐射功率可高达 4.4 mW，但由于光束是不断移动的，因此对视力的危害较小。MCU 程序具有特殊的电机速度检查功能，如果速度过高或过低，激光器都会关闭。

### 测距仪控制

为了配置和控制测距仪，我为 PC 编写了两个实用程序。第一个用于在非扫描模式下设置和测试测距仪。在这里，您可以调整激光和光电探测器的参数，但最主要的是查看来自 TDC 的数据：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311185823293.png" alt="image-20240311185823293" style="zoom: 33%;" />

该程序向测距仪发送 100 次测量的命令，测量结果存储在 MCU 存储器中，然后发送到 PC 进行分析。分析结果显示在程序中心的窗口中，并在此基础上绘制了显示飞行时间测量结果变化的直方图（START 栏）。为了收集用于校准的数据，该工具可以将 100 次测量的平均值保存到文件中。校准过程包括以下项目：

* 开始记录数据。

* 信号的振幅要平稳调整，而距离则应保持不变。为了调节振幅，我用一块不透明的板遮住光电二极管透镜。振幅水平由脉冲持续时间 (WIDTH) 的值间接控制。

* 收集足够多的点后，必须停止记录并转到 "校准 "选项卡。在此对记录的数据进行处理。它们看起来像这样：

  <img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311185905972.png" alt="image-20240311185905972" style="zoom:50%;" />

  该图的横轴是以 BIN 为单位的脉冲持续时间值，纵轴是飞行时间的相对变化。该选项卡还用于对收集到的数据进行指数函数近似。得到的函数在图中用红色曲线表示。经过近似处理后，可以找到表征该函数的两个系数。应将其写入 MCU 存储器。

此外，使用该实用程序还可以监控激光雷达电机的运行。

下一个实用程序用于检查激光雷达在扫描这一主要模式下的运行情况。这里主要是显示激光雷达的扫描结果：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311190041106.png" alt="image-20240311190041106" style="zoom:50%;" />

可以看到部分空间（图像底部）没有扫描。在这一区域内，有放置扫描机械和校准板的支架。该区域的大小应手动设置。您还可以在实用程序中调整激光雷达的某些参数，并对所选角度的距离测量质量进行简单分析。此外，还可以使用获得的数据绘制直方图（同样是一个角度）：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311190007508.png" alt="image-20240311190007508" style="zoom: 50%;" />

这里的横轴是厘米。GitHub 上的项目对其他距离也有类似的测量方法。

## 成果

由此产生的激光雷达具有以下特点：

* 扫描速度：15 转/秒。这一速度部分受限于 MCU 软件（需要进一步优化）、振动程度（反射镜的平衡性不佳）和安全考虑因素--扫描速度越高，空间中某一点的平均撞击能量就越高。
* 测量精度。TDC 的一个 BIN 等于 ~13 毫米。距离测量的噪声水平与距离、表面类型、激光束在表面上的入射角有很大关系。例如，在距离 10 米的浅灰色墙壁上，20 次扫描的最大误差为 3 厘米（0.3%），距离 20 米时为 13 厘米，25 米时为 17 厘米，30 米时为 30 厘米（1%）。然而，即使距离很近，也几乎不可能获得小于 2 厘米的噪音水平。
  最小测量距离：5 厘米，最大 ~25 米（白色物体表面）
* 测量频率 11 千赫
* 角度分辨率：0.5 度
* 扫描角度范围：230 度。可通过重新设计激光雷达机械结构来扩展该范围
* 消耗：5 V 时 0.1 A（0.5 W）。浪涌电流可达 0.8A
* 尺寸：50x50x120 毫米

## 现有激光雷达设计的问题和未实现的功能

我的激光雷达尚未解决的最重要问题是补偿激光雷达电子元件对温度的敏感性。APD 对温度最为敏感，其增益会随着温度的升高而大幅降低。温度在 0-40 度范围内的变化会导致增益发生数倍的变化。最正确的方法是测量 APD 的温度，然后调整施加在它上面的电压。电路中甚至有一个特殊的热敏电阻（NTC）用于温度测量，但我并没有在固件中实现电压调整，因为这相当复杂，必须研究 APD 在整个所需温度范围内的行为。


另一个未实现的功能是 TDC 校准。所有 TDC 实例的元件间延迟时间（BIN）都略有不同。此外，该时间还与温度有关。TDC 芯片本身有一个特殊的校准机制，但为了简化，我没有在固件中实现它。现在，BIN 值是在 MCU 代码中硬性设置的。


由于光束的发散性相当大，对狭窄物体（例如椅子腿）距离的测量可能不正确，因为连续几个物体都落入光束中。当光束从一个距离突然移动到另一个距离时，也会出现同样的问题。这在扫描中表现为在正确测量之间出现几个假点。

为 APD MTAPD-07-13 设计的电路板 "PCB_project_v4 "版本对附近 Wi-Fi 天线的辐射非常敏感。具体表现为：在 Wi-Fi 运行期间，激光雷达数据变得非常嘈杂（测量精度下降了数倍）。据我所知，信号是在光电二极管放大器的输入端引起的。试图屏蔽电路板并没有什么用，我甚至试过把电路板放在一个没有盖子的金属罐里。只有在完全屏蔽的情况下，信号才会丢失，而这在激光雷达中是不可能的。只有将天线安装在激光雷达的非工作部分后面，并在两者之间安装一个特殊的金属板屏蔽罩才会有帮助。

在为使用 APD AD500-8 而设计的前一版本电路板中，这种效果要弱得多。电路板的布线略有不同，旧版电路板的放大器安装在电路板的底部，光电二极管有一个金属外壳，这可能会改善这种情况。

MCU 代码优化不够。可以改进编码器数据处理，通过 SPI 使用中断而不是现在的轮询实现与 TDC 的通信。所有这些改进都需要时间，而时间总是很紧迫。扫描机构的机械原理并不是最成功的（但尽可能简单）。在旋转过程中，由于平衡不够好，镜子会有一些震动。无论我尝试多少次，都无法完全消除振动。由于镜子上的反射，无法使用大直径的光电探测器镜头。

## 组件成本

|                  | 价格, $ |                   说明                   |
| :--------------: | :-----: | :--------------------------------------: |
|     **PCB**      |   13    |             Цена за 10 штук              |
|    激光二极管    |   12    |                SPL PL90_3                |
|       APD        |  10/24  |           AD500-8/MTAPD-07-013           |
|       芯片       |   ~30   | 所有微型芯片 (TIA, TDC, MCU, Mosfet ...) |
|     其他组件     |   ~7    |                                          |
|   **光学器件**   |         |                                          |
|     镜头 APD     |    9    |              CS mount, 25mm              |
|     镜头支架     |    2    |                 CS mount                 |
|     激光透镜     |    7    |                M12, 25mm                 |
| 镜头支架和适配器 |    5    |                   M12                    |
|      扫描镜      |   12    |                4 件的价格                |
|   **机械组件**   |         |                                          |
|       机架       |    3    |         六角形货架，每 20 件价格         |
|   无刷直流电机   |    2    |                                          |
|   其他详细信息   |    2    |                                          |
|        -         |         |                                          |
|     **总计**     |   114   |                                          |

不含运费的元件总成本约为 114 美元（使用 APD AD500-8）。值得注意的是，有些元件（如印刷电路板和反射镜）是分批出售的，总成本中包含了分批出售的成本。光学镜片及其支架相当昂贵，价格为 23 美元。如果使用单透镜和自制支架，光学元件的成本可能会降低数倍。

## 激光雷达的实际应用

我决定将激光雷达安装在一台长期受苦的 Roomba 吸尘器上（从 2012 年起我就开始在上面安装自制的激光雷达），以测试激光雷达的工作情况。激光雷达与一台运行 ROS 和 SLAM 的 Orange Pi PC 相连。它看起来是这样的：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311190544476.png" alt="image-20240311190544476" style="zoom:67%;" />

为了将激光雷达的数据发送到 ROS，我专门编写了一个节点。下面是一个激光雷达数据示例：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311190612176.png" alt="image-20240311190612176" style="zoom:50%;" />

图像中的单元长度为 1 米。下图中，测距仪 "看 "过一条形状复杂的走廊。SLAM 的结果是这样一张地图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311190639291.png" alt="image-20240311190639291" style="zoom:50%;" />

平面中央有一个镜面橱柜；在扫描前，我用塑料板遮住了部分镜面，但结果发现塑料板太低，所以在某些点光束仍然会打到镜面上。如果在足够大的房间里运行 SLAM，就会得到这样的地图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311190709877.png" alt="image-20240311190709877" style="zoom: 67%;" />

由于这间房间里摆放着大量闪闪发光的椅子，墙壁又很暗，所以扫描起来非常困难。

## 类似项目

这样的项目并不多。首先，我们应该提到开源激光雷达项目 [Unruly](https://hackaday.io/project/163501-open-source-lidar-unruly)。遗憾的是，目前这个项目已经冻结或停止--没有任何关于其状态的信息。事实上，该项目发布的主要内容是激光雷达的方案及其特性信息。我不会隐瞒我从这个项目中获取的部分方案。


值得一提的还有 TI 的参考设计：[TIDA-00663](http://www.ti.com/tool/TIDA-00663)。这是一个相当详细的开放项目，但它有一个缺点--电路板设计根本不适合安装光学器件。因此，文档中根本没有实际光学器件的测试结果。此外，该项目使用的是普通 PIN 光电二极管，而不是 APD。


更新日期：2021 年 2 月 2 日：我从安森美半导体（ON Semiconductor）找到了这份相当有趣的文档：[UM70015](https://www.onsemi.com/pub/Collateral/UM70015-D.PDF)。它使用 SiPM 作为光电探测器，完全没有使用 TIA。它使用 FPGA 作为 TDC。


遗憾的是，我不熟悉其他类似项目（即相当简单，不使用 FPGA 和高速 ADC）。在互联网上经常可以找到各种学生作品，但他们往往没有给出最终设备的参数，或者使用了困难/昂贵的元件。在这种情况下，通常没有必要谈论固件和 Geber 文件在公共领域的可用性。
